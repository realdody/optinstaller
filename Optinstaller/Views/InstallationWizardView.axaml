<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Optinstaller.ViewModels"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="Optinstaller.Views.InstallationWizardView"
             x:DataType="vm:InstallationWizardViewModel">

    <Border Background="{DynamicResource SolidBackgroundFillColorBaseBrush}" Padding="20" CornerRadius="8">
        <Grid RowDefinitions="Auto,*,Auto">
            
            <!-- Header -->
            <TextBlock Grid.Row="0" Text="{Binding Title}" Theme="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,20"/>

            <!-- Content Area -->
            <Panel Grid.Row="1">
                
                <!-- Step 0: Welcome / Engine Check -->
                <StackPanel IsVisible="{Binding IsStep0}" Spacing="15">
                     <TextBlock Text="Welcome to the OptiScaler Installer." FontSize="16"/>
                     <TextBlock Text="This wizard will guide you through configuring OptiScaler for your game."/>
                     
                     <Border Background="{DynamicResource SystemFillColorCautionBrush}" Padding="15" CornerRadius="4" 
                             IsVisible="{Binding ShowEngineWarning}">
                         <StackPanel>
                             <TextBlock Text="⚠️ Engine Folder Detected" FontWeight="Bold" Foreground="Black"/>
                             <TextBlock Text="If this is an Unreal Engine game, you likely need to install OptiScaler in: Binaries\Win64" 
                                        TextWrapping="Wrap" Foreground="Black" Margin="0,5,0,0"/>
                             <TextBlock Text="Proceed only if you are sure this is the correct folder." 
                                        Foreground="Black" Margin="0,5,0,0"/>
                         </StackPanel>
                     </Border>
                </StackPanel>

                <!-- Step 1: Filename -->
                <StackPanel IsVisible="{Binding IsStep1}" Spacing="15">
                    <TextBlock Text="Choose a filename for OptiScaler dll:" FontWeight="SemiBold"/>
                    <TextBlock Text="Default is dxgi.dll (most compatible)." FontSize="12" Opacity="0.7"/>
                    
                    <ComboBox ItemsSource="{Binding Filenames}" SelectedItem="{Binding SelectedFilename}" HorizontalAlignment="Stretch"/>
                    
                    <Border Background="{DynamicResource SystemFillColorCriticalBrush}" Padding="10" CornerRadius="4" 
                            IsVisible="{Binding FileExistsWarning}">
                        <TextBlock Text="Warning: File already exists! Click Next again to overwrite." Foreground="White"/>
                    </Border>
                </StackPanel>

                <!-- Step 2: GPU / Spoofing -->
                <StackPanel IsVisible="{Binding IsStep2}" Spacing="15">
                    <TextBlock Text="GPU &amp; Configuration" FontWeight="SemiBold"/>
                    
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="Detected Environment:"/>
                        <TextBlock Text="{Binding GpuName}" FontWeight="Bold"/>
                    </StackPanel>

                    <TextBlock Text="DLSS Spoofing allows FSR/XeSS to replace DLSS." Margin="0,10,0,0"/>
                    <CheckBox Content="Enable DLSS Spoofing" IsChecked="{Binding EnableSpoofing}"/>
                    <TextBlock Text="Required for DLSS Frame Gen. Disable if using FSR/XeSS natively." FontSize="12" Opacity="0.6"/>
                    
                    <TextBlock Text="Note: On Nvidia GPUs, this setting is usually auto-managed." 
                               IsVisible="{Binding IsNvidia}" FontSize="12" Foreground="{DynamicResource SystemAccentColor}"/>
                </StackPanel>

                <!-- Step 3: OptiPatcher -->
                <StackPanel IsVisible="{Binding IsStep3}" Spacing="15">
                    <TextBlock Text="OptiPatcher" FontWeight="SemiBold"/>
                    
                    <TextBlock Text="{Binding OptiPatcherStatus}"/>
                    
                    <StackPanel IsVisible="{Binding OptiPatcherSupported}">
                        <CheckBox Content="Download &amp; Install OptiPatcher.asi" IsChecked="{Binding UseOptiPatcher}"/>
                        <TextBlock Text="OptiPatcher improves compatibility by patching game checks." FontSize="12" Opacity="0.6"/>
                    </StackPanel>
                    
                    <ProgressBar IsIndeterminate="True" IsVisible="{Binding CheckingOptiPatcher}"/>
                </StackPanel>

                <!-- Step 4: Summary -->
                <StackPanel IsVisible="{Binding IsStep4}" Spacing="15">
                    <TextBlock Text="Ready to Install" FontWeight="SemiBold"/>
                    <TextBlock Text="Click Install to begin."/>
                    
                    <CheckBox Content="Create 'Remove OptiScaler.bat' uninstaller" IsChecked="{Binding CreateUninstaller}"/>
                </StackPanel>

                <!-- Step 5: Finish -->
                <StackPanel IsVisible="{Binding IsStep5}" Spacing="15" VerticalAlignment="Center">
                    <TextBlock Text="{Binding InstallStatus}" HorizontalAlignment="Center" FontWeight="Bold" FontSize="18"/>
                    <ProgressBar IsIndeterminate="True" IsVisible="{Binding IsInstalling}" Width="200"/>
                    
                    <TextBlock Text="ASCII Art Placeholder: Coping is strong with this one..." 
                               HorizontalAlignment="Center" FontFamily="Consolas" Opacity="0.5" 
                               IsVisible="{Binding InstallSuccess}"/>
                </StackPanel>

            </Panel>

            <!-- Footer Actions -->
            <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" Margin="0,20,0,0">
                <Button Grid.Column="0" Content="Back" Command="{Binding BackCommand}" IsVisible="{Binding CanGoBack}"/>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                    <Button Content="Cancel" Command="{Binding CloseCommand}" IsVisible="{Binding !InstallSuccess}"/>
                    <Button Content="{Binding NextButtonText}" Command="{Binding NextCommand}" 
                            Classes="accent" IsVisible="{Binding !InstallSuccess}" IsEnabled="{Binding !IsInstalling}"/>
                    <Button Content="Finish" Command="{Binding CloseCommand}" IsVisible="{Binding InstallSuccess}" Classes="accent"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</UserControl>